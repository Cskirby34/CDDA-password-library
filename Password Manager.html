<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8" />
 <meta name="viewport" content="width=device-width, initial-scale=1" />
 <title>Secure Password Manager</title>
 <style>
   :root { --bg:#0b1020; --panel:#121934; --muted:#a8b3cf; --text:#e8edff; --accent:#7aa2ff; --danger:#ff6b6b; }
   *{box-sizing:border-box}
   body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#0b1020,#0b132a);color:var(--text);min-height:100dvh;}
   header{padding:24px 16px;text-align:center;border-bottom:1px solid rgba(255,255,255,.08)}
   h1{margin:0;font-size:28px;letter-spacing:.3px}
   main{max-width:980px;margin:24px auto;padding:0 16px;}
   .card{background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
   .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
   .grid{display:grid;gap:12px}
   .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
   label{font-size:13px;color:var(--muted)}
   input,select,button,textarea{font:inherit}
   input[type="password"], input[type="text"], input[type="number"], textarea {width:100%;padding:12px 14px;background:#0d142f;border:1px solid rgba(255,255,255,.12);border-radius:12px;color:var(--text)}
   input::placeholder{color:#7f8ab2}
   button{padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#111a3d;color:var(--text);cursor:pointer}
   button.primary{background:var(--accent);border-color:transparent;color:#081531;font-weight:600}
   button.ghost{background:transparent}
   button.danger{background:var(--danger);border-color:transparent;color:#340a0a}
   .toolbar{display:flex;gap:8px;flex-wrap:wrap}
   .muted{color:var(--muted);font-size:13px}
   .entry{padding:12px;border:1px dashed rgba(255,255,255,.12);border-radius:10px}
   .entry .row{justify-content:space-between}
   .kvs{display:grid;grid-template-columns:160px 1fr;gap:10px;font-size:14px}
   .tag{font-size:12px;color:#98a5c7;background:#0f1838;border:1px solid rgba(255,255,255,.1);padding:2px 8px;border-radius:999px}
   .footer{margin-top:16px;display:flex;justify-content:space-between;align-items:center}
   .hidden{display:none}
   .hr{height:1px;background:rgba(255,255,255,.08);margin:12px 0}
   .right{margin-left:auto}
   .center{text-align:center}
   .small{font-size:12px}
   code.small{font-size:12px;color:#d6dfff;background:#0f1735;padding:2px 6px;border-radius:6px}
 </style>
</head>
<body>
 <header>
   <h1>üîê Secure Password Manager</h1>
   <div class="muted small">All data is encrypted locally with a key derived from your master password. Nothing leaves your browser.</div>
 </header>
 <main>
   <!-- Onboarding / Unlock -->
   <section id="unlock" class="card">
     <div id="firstRun" class="grid">
       <h2>Create your vault</h2>
       <div class="grid cols-2">
         <div>
           <label>Master Password</label>
           <input id="newMaster" type="password" autocomplete="new-password" placeholder="Create a strong master password" />
         </div>
         <div>
           <label>Confirm Master Password</label>
           <input id="newMaster2" type="password" autocomplete="new-password" placeholder="Retype master password" />
         </div>
       </div>
       <div class="row">
         <button class="primary" id="btnCreate">Create Vault</button>
       </div>
     </div>


     <div id="login" class="grid hidden">
       <h2>Unlock your vault</h2>
       <div class="grid cols-2">
         <div>
           <label>Master Password</label>
           <input id="master" type="password" autocomplete="current-password" placeholder="Enter master password" />
         </div>
         <div class="row" style="align-self:end">
           <button class="primary" id="btnUnlock">Unlock</button>
           <button class="ghost" id="btnWipe" title="Delete local encrypted data (cannot be undone)">Reset / Wipe</button>
         </div>
       </div>
       <div id="unlockMsg" class="muted"></div>
     </div>
   </section>


   <!-- App -->
   <section id="app" class="card hidden">
     <div class="toolbar">
       <button class="primary" id="btnAdd">+ Add Entry</button>
       <button id="btnSave">Save Vault</button>
       <input type="file" id="fileImport" class="hidden" accept="application/json" />
       <span class="right tag" id="status">Unlocked</span>
     </div>
     <div class="hr"></div>


     <!-- Add/Edit form -->
     <div id="formWrap" class="grid hidden">
       <h3 id="formTitle">New Entry</h3>
       <div class="grid cols-2">
         <div>
           <label>Site / Label</label>
           <input id="f_site" type="text" placeholder="example.com or label" />
         </div>
         <div>
           <label>Username</label>
           <input id="f_user" type="text" placeholder="name@example.com" />
         </div>
         <div>
           <label>Password</label>
           <div class="row">
             <input id="f_pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
             <button id="btnTogglePass" type="button">Show</button>
             <button id="btnGen" type="button">Generate</button>
             <button id="btnCopy" type="button">Copy</button>
           </div>
           <div class="row small muted">
             <label>Length <input id="genLen" type="number" value="20" min="8" max="64" style="width:80px;margin-left:6px"/></label>
             <label><input type="checkbox" id="genUpper" checked /> Upper</label>
             <label><input type="checkbox" id="genLower" checked /> Lower</label>
             <label><input type="checkbox" id="genDigits" checked /> Digits</label>
             <label><input type="checkbox" id="genSymbols" checked /> Symbols</label>
           </div>
         </div>
       </div>
       <div class="row">
         <button class="primary" id="btnSaveEntry">Save Entry</button>
         <button class="ghost" id="btnCancelEntry">Cancel</button>
       </div>
       <div class="hr"></div>
     </div>


     <!-- Entries list -->
     <div id="list" class="grid"></div>


     <div class="footer">
       <button class="danger" id="btnLock">Lock</button>
     </div>
   </section>
 </main>


 <script>
 // ===== Utilities =====
 const $ = sel => document.querySelector(sel);
 const $$ = sel => Array.from(document.querySelectorAll(sel));
 const encB64 = buf => btoa(String.fromCharCode(...new Uint8Array(buf)));
 const decB64 = b64 => Uint8Array.from(atob(b64), c => c.charCodeAt(0));
 const textEnc = new TextEncoder();
 const textDec = new TextDecoder();


 const VAULT_KEY = 'spm.vault';
 const META_KEY  = 'spm.meta';


 // ===== Crypto Primitives (Web Crypto) =====
 async function deriveKey(password, saltB64, iterations){
   const salt = saltB64 ? decB64(saltB64) : crypto.getRandomValues(new Uint8Array(16));
   const baseKey = await crypto.subtle.importKey('raw', textEnc.encode(password), 'PBKDF2', false, ['deriveKey']);
   const key = await crypto.subtle.deriveKey(
     { name: 'PBKDF2', salt, iterations, hash: 'SHA-256' },
     baseKey,
     { name: 'AES-GCM', length: 256 },
     false,
     ['encrypt','decrypt']
   );
   return { key, saltB64: encB64(salt) };
 }


 async function encryptJSON(key, obj){
   const iv = crypto.getRandomValues(new Uint8Array(12));
   const data = textEnc.encode(JSON.stringify(obj));
   const ct = await crypto.subtle.encrypt({name:'AES-GCM', iv}, key, data);
   return { iv: encB64(iv), ct: encB64(ct) };
 }


 async function decryptJSON(key, blob){
   try{
     const iv = decB64(blob.iv);
     const ct = decB64(blob.ct);
     const pt = await crypto.subtle.decrypt({name:'AES-GCM', iv}, key, ct);
     return JSON.parse(textDec.decode(pt));
   }catch(e){
     throw new Error('Decryption failed');
   }
 }


 // ===== State =====
 let state = {
   meta: null,         // {version, iterations, saltB64}
   key: null,          // CryptoKey
   entries: [],        // [{id, site, user, pass}]
   editingId: null,
 };


 // ===== Storage =====
 function hasVault(){
   return !!localStorage.getItem(VAULT_KEY);
 }
 function saveEncryptedVault(blob){
   localStorage.setItem(VAULT_KEY, JSON.stringify(blob));
 }
 function loadEncryptedVault(){
   const raw = localStorage.getItem(VAULT_KEY);
   return raw ? JSON.parse(raw) : null;
 }
 function saveMeta(meta){
   localStorage.setItem(META_KEY, JSON.stringify(meta));
 }
 function loadMeta(){
   const raw = localStorage.getItem(META_KEY);
   return raw ? JSON.parse(raw) : null;
 }
 function wipeAll(){
   localStorage.removeItem(VAULT_KEY);
   localStorage.removeItem(META_KEY);
 }


 // ===== UI Routing =====
 function show(el, yes=true){ el.classList.toggle('hidden', !yes); }
 function setStatus(msg){ $('#status').textContent = msg; }


 function renderEntries(){
   const list = $('#list');
   list.innerHTML = '';
   if(!state.entries.length){
     list.innerHTML = '<div class="muted">No entries yet. Click <b>+ Add Entry</b> to create one.</div>';
     return;
   }
   state.entries.forEach(e => {
     const div = document.createElement('div');
     div.className = 'entry grid';
     div.innerHTML = `
       <div class="row">
         <strong>${escapeHtml(e.site)}</strong>
         <span class="tag">${escapeHtml(e.user)}</span>
         <span class="right small muted">id:${e.id.slice(0,6)}</span>
       </div>
       <div class="kvs">
         <div class="muted">Password</div>
         <div class="row">
           <input type="password" value="${escapeHtml(e.pass)}" readonly style="max-width:360px" />
           <button data-act="reveal" data-id="${e.id}">Show</button>
           <button data-act="copy" data-id="${e.id}">Copy</button>
           <button data-act="edit" class="ghost" data-id="${e.id}">Edit</button>
           <button data-act="del" class="ghost" data-id="${e.id}">Delete</button>
         </div>
       </div>`;
     list.appendChild(div);
   });
 }


 function escapeHtml(s){
   return (s||'').replace(/[&<>"]+/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
 }


 function openForm(entry){
   show($('#formWrap'), true);
   $('#formTitle').textContent = entry ? 'Edit Entry' : 'New Entry';
   state.editingId = entry ? entry.id : null;
   $('#f_site').value = entry?.site || '';
   $('#f_user').value = entry?.user || '';
   $('#f_pass').value = entry?.pass || '';
 }


 function closeForm(){
   show($('#formWrap'), false);
   state.editingId = null;
   $('#f_site').value = '';
   $('#f_user').value = '';
   $('#f_pass').value = '';
 }


 // ===== Generator =====
 function generatePassword(opts){
   const sets = [];
   if(opts.upper) sets.push('ABCDEFGHIJKLMNOPQRSTUVWXYZ');
   if(opts.lower) sets.push('abcdefghijklmnopqrstuvwxyz');
   if(opts.digits) sets.push('0123456789');
   if(opts.symbols) sets.push('!@#$%^&*()-_=+[]{};:,.?/');
   if(!sets.length) throw new Error('Select at least one character set');
   const all = sets.join('');
   const out = [];
   const bytes = new Uint8Array(opts.length);
   crypto.getRandomValues(bytes);
   for(let i=0;i<opts.length;i++){
     const idx = bytes[i] % all.length;
     out.push(all[idx]);
   }
   return out.join('');
 }


 // ===== App Logic =====
 async function createVault(){
   const p1 = $('#newMaster').value.trim();
   const p2 = $('#newMaster2').value.trim();
   if(!p1 || p1.length < 10) return alert('Use a longer master password (10+ characters recommended).');
   if(p1 !== p2) return alert('Passwords do not match.');


   const iterations = 310000; // OWASP-style modern PBKDF2 iteration count (fast on desktop)
   const { key, saltB64 } = await deriveKey(p1, null, iterations);
   state.key = key;
   state.meta = { version: 1, iterations, saltB64 };
   state.entries = [];


   const blob = await encryptJSON(state.key, state.entries);
   saveEncryptedVault(blob);
   saveMeta(state.meta);


   $('#newMaster').value = ''; $('#newMaster2').value = '';
   enterApp();
 }


 async function unlockVault(){
   const mpw = $('#master').value;
   const meta = loadMeta();
   if(!meta) return alert('No metadata found. If this is a new setup, use Create Vault.');
   try{
     const { key } = await deriveKey(mpw, meta.saltB64, meta.iterations);
     const blob = loadEncryptedVault();
     const entries = await decryptJSON(key, blob);
     state.key = key;
     state.meta = meta;
     state.entries = entries;
     $('#master').value = '';
     enterApp();
   }catch(e){
     $('#unlockMsg').textContent = 'Incorrect password or corrupted data.';
   }
 }


 async function saveVault(){
   const blob = await encryptJSON(state.key, state.entries);
   saveEncryptedVault(blob);
   setStatus('Saved ‚úì');
   setTimeout(()=>setStatus('Unlocked'), 1200);
 }


 function enterApp(){
   show($('#unlock'), false);
   show($('#app'), true);
   renderEntries();
 }


 function backToUnlock(){
   state = { meta: loadMeta(), key: null, entries: [], editingId: null };
   show($('#app'), false);
   show($('#unlock'), true);
   if(hasVault()){
     show($('#firstRun'), false);
     show($('#login'), true);
   }else{
     show($('#firstRun'), true);
     show($('#login'), false);
   }
 }


 // ===== Event Wiring =====
 document.addEventListener('click', async (e)=>{
   const t = e.target;
   if(t.id === 'btnCreate') createVault();
   if(t.id === 'btnUnlock') unlockVault();
   if(t.id === 'btnWipe'){
     if(confirm('This will delete your encrypted vault from this browser. Continue?')){ wipeAll(); backToUnlock(); }
   }
   if(t.id === 'btnAdd') openForm();
   if(t.id === 'btnCancelEntry') closeForm();
   if(t.id === 'btnTogglePass'){
     const inp = $('#f_pass'); inp.type = inp.type === 'password' ? 'text' : 'password';
     t.textContent = inp.type === 'password' ? 'Show' : 'Hide';
   }
   if(t.id === 'btnGen'){
     try{
       const pwd = generatePassword({
         length: +$('#genLen').value,
         upper: $('#genUpper').checked,
         lower: $('#genLower').checked,
         digits: $('#genDigits').checked,
         symbols: $('#genSymbols').checked,
       });
       $('#f_pass').value = pwd;
     }catch(err){ alert(err.message); }
   }
   if(t.id === 'btnCopy'){
     const v = $('#f_pass').value; await navigator.clipboard.writeText(v); t.textContent='Copied'; setTimeout(()=>t.textContent='Copy',900);
   }
   if(t.id === 'btnSaveEntry'){
     const site = $('#f_site').value.trim();
     const user = $('#f_user').value.trim();
     const pass = $('#f_pass').value;
     if(!site || !user || !pass) return alert('Please fill site, username, and password.');
     if(state.editingId){
       const i = state.entries.findIndex(x=>x.id===state.editingId);
       if(i>=0) state.entries[i] = { id: state.editingId, site, user, pass };
     }else{
       state.entries.push({ id: crypto.randomUUID(), site, user, pass });
     }
     closeForm(); renderEntries(); await saveVault();
   }
   if(t.id === 'btnSave') saveVault();
   if(t.id === 'btnLock') { state.key=null; state.entries=[]; backToUnlock(); }
   if(t.id === 'btnExport'){
     const blob = new Blob([localStorage.getItem(VAULT_KEY)||'{}'], {type:'application/json'});
     const url = URL.createObjectURL(blob);
     const a = Object.assign(document.createElement('a'), {href:url, download:'vault.encrypted.json'});
     document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
   }
   if(t.id === 'btnImport') $('#fileImport').click();


   // List actions (reveal/copy/edit/del)
   if(t.dataset && t.dataset.act){
     const id = t.dataset.id;
     const entry = state.entries.find(x=>x.id===id);
     if(!entry) return;
     if(t.dataset.act==='reveal'){
       const input = t.parentElement.querySelector('input');
       input.type = input.type === 'password' ? 'text' : 'password';
       t.textContent = input.type==='password' ? 'Show' : 'Hide';
     }
     if(t.dataset.act==='copy'){
       await navigator.clipboard.writeText(entry.pass);
       t.textContent='Copied'; setTimeout(()=>t.textContent='Copy',900);
     }
     if(t.dataset.act==='edit') openForm(entry);
     if(t.dataset.act==='del'){
       if(confirm('Delete this entry?')){ state.entries = state.entries.filter(x=>x.id!==id); renderEntries(); await saveVault(); }
     }
   }
 });


 $('#fileImport').addEventListener('change', async (e)=>{
   const file = e.target.files[0];
   if(!file) return;
   const txt = await file.text();
   try{
     JSON.parse(txt); // basic validation
     localStorage.setItem(VAULT_KEY, txt);
     alert('Encrypted vault imported. Now unlock with your master password.');
     backToUnlock();
   }catch{
     alert('Invalid file.');
   }
 });


 // ===== Init =====
 (function init(){
   if(hasVault()){
     show($('#firstRun'), false);
     show($('#login'), true);
     state.meta = loadMeta();
   }else{
     show($('#firstRun'), true);
     show($('#login'), false);
   }
 })();
 </script>
</body>
</html>



